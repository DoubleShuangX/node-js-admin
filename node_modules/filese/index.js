module.exports=function(dir){
	var getDir=dir;
    var multer  = require('multer');
    var fs = require("fs");
	if(dir){
		var storage = multer.diskStorage({
			destination: function (req, file, cb) {
				var dir=getDir;
				
				multer({dest:dir});
				cb(null, dir);
			},
			filename: function (req, file, cb) {
				cb(null,Date.now() + "-"+Math.round(Math.random()*10000000)+"-"+ file.originalname);	
			}
		})
	}
	var nextFn=function(req,res,next){
		if(req.file){
			if(((req.file.size/1024)/1024)/1024>=1){
				req.file.size=((req.file.size/1024)/1024)/1024+"g"
			}else if((req.file.size/1024)/1024>=1){
				req.file.size=((req.file.size/1024)/1024)+"m";
			}else if((req.file.size/1024)>=1){
				req.file.size=(req.file.size/1024)+"kb";
			}else{
				req.file.size=req.file.size+"b";
			}
			req.file.extended=req.file.originalname.match(/\.\w+?$/)[0];
			var sk=req.file.destination.split("/");
			sk=sk.filter(function(i,k){if(i) return i});
			if(sk.length>1){
				req.file.rdestination=sk[sk.length-1]+"/"+req.file.filename;
			}else{
				req.file.rdestination=req.file.filename
			}
			
		}
		else if(req.files){
			if(req.files.length>0){
				for(var i=0;i<req.files.length;i++){
					if(((req.files[i].size/1024)/1024)/1024>=1){
						req.files[i].size=((req.files[i].size/1024)/1024)/1024+"g"
					}else if((req.files[i].size/1024)/1024>=1){
						req.files[i].size=((req.files[i].size/1024)/1024)+"m";
					}else if((req.files[i].size/1024)>=1){
						req.files[i].size=(req.files[i].size/1024)+"kb";
					}else{
						req.files[i].size=req.files[i].size+"b";
					}
					req.files[i].extended=req.files[i].originalname.match(/\.\w+?$/)[0];
					var sk=req.files[i].destination.split("/");
					sk=sk.filter(function(i,k){if(i) return i});
					if(sk.length>1){
						req.files[i].rdestination=sk[sk.length-1]+"/"+req.files[i].filename;
					}else{
						req.files[i].rdestination=req.files[i].filename
					}
				}
			}
		}
		next();
	}
	var obj={};
	obj.single=function(name){
		return [multer({ storage: storage }).single(name),nextFn];
	}
	obj.array=function(name,num){
		return [multer({ storage: storage }).array(name,num),nextFn];
	}
	obj.fields=function(arr){
		return [multer({ storage: storage }).fields(arr),nextFn];
	}
	obj.deleteFile=function(paths,fn){
		fs.exists(paths, function(exist) {
			/*
			 * exist 的值为布尔
			 * false 不存在
			 * true 存在
			 */
			if(fn){
				if(!exist){
					fn({exist:exist})
				}
						
			}
			
			if(exist) {
				fs.unlink(paths, function(err) {
					if(err) {
						console.error();
						throw err;
					}
					if(fn){
						fn({exist:exist,deletes:true})
					}
				});
			}
		})
	}
    
	return obj;
}






